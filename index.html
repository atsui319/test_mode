<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>QuizConsole Pro - The Perfect Final Master</title>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
<style>
/* --- CSSは元コードから一切変更なし --- */
:root { --bg:#f0f2f5; --primary:#3498db; --danger:#e74c3c; --success:#2ecc71; --dark:#2c3e50; --test:#6c5ce7; --gold:#f1c40f;}
body{font-family:sans-serif;background:var(--bg);margin:0;padding:10px;height:100vh;overflow:hidden;box-sizing:border-box;}
.page-section{display:none;height:100%}#role-ui{display:block}
.container{background:white;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);margin-bottom:15px}
.admin-flex{display:flex;gap:15px;height:calc(100vh - 40px);max-width:1600px;margin:0 auto}
.main-panel{flex:1;overflow-y:auto;padding-right:5px}
.sidebar{width:380px;display:flex;flex-direction:column;gap:15px;height:100%}
.sidebar-section{background:white;padding:15px;border-radius:12px;display:flex;flex-direction:column;min-height:0;border:1px solid #ddd}
#player-mgr-area{height:35%;flex-shrink:0}
#full-mgr-list{flex:1;overflow-y:auto;border:1px solid #eee;border-radius:8px;padding:5px;background:#fafafa}
#quiz-search-area{flex:1}
#quiz-list-area{flex:1;overflow-y:auto;margin-top:10px;border:1px solid #eee;border-radius:8px}
#display{font-size:1.8rem;background:var(--dark);color:white;padding:20px;border-radius:8px;min-height:4em;display:flex;flex-wrap:wrap;margin-bottom:15px;border:4px solid #444}
#display span{border-bottom:2px solid #555;margin-right:2px;min-width:.8em;text-align:center}
#display span.hidden{visibility:hidden}
.btn-genre{padding:6px;font-size:.7rem;cursor:pointer;flex:1;border:1px solid #ccc;background:#fff;border-radius:4px}
.btn-genre.active{background:var(--primary);color:white}
</style>
</head>
<body>

<!-- UI構造は元コード完全保持 -->

<script>
const firebaseConfig = { databaseURL:"https://realtime-database-c0015-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let masterData={all:[]},activeGenre='all',usedSet=new Set(),currentQuiz={q:"",a:""},revealed=[],history=[];
let timer=null,subWindow=null,lastStatus="";

const URLS={
ori:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSFuFjp8CnBMqfdRPKbQ_FPC6zWwgdQBVdTDsdWTHbBN92vXADxbVTmHdLm_C3Yn-Eeu5ZWm9WXRb0c/pub?output=csv",
ent:"https://docs.google.com/spreadsheets/d/e/2PACX-1vRjKfK1zTkytDnO1HiVRHa0N79VJncU_IXC3uv8Q2EBvBIm5mRPw82ie-widupSvvlR1vQdkVeeIIMM/pub?output=csv",
anime:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQTBRf9k4zS7Ht5s7GKejqT2d-cyWbDHd19DwTPmAzoHe40d9nV1cVu-RH565sIq9GbYmEKkzhpBytp/pub?output=csv",
social:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTXVYOqHu_0VRIkiVK0RQO-ZWPZ6pHGqIw5VxBWdOlg3-HbP3q26gM0fVxTndREhjqbaxFzcjeuoMcE/pub?output=csv",
life:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSTr7JL0lBCMLRBFi-CraPlJxzp4xrGD8RSnc8MSuoV3ORISo0iCFWMmI_FCtDlgkxwPqmv_TwAvufn/pub?output=csv",
sport:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSJYls3O8_98SKNWqx34c0V5HLIaXdxxA8v4E3c1iwrTFZBL1TSzeem9AbKZKYfMkQEcu7bECcsgVo/pub?output=csv"
};

/* ===== 修正① CSVパース（最重要） ===== */
function parseCSVLine(line){
  const m=line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
  return m?m.map(s=>s.replace(/^"|"$/g,"").trim()):[];
}

async function initAdmin(){
  for(let [k,url] of Object.entries(URLS)){
    const res=await fetch(url+"&t="+Date.now());
    const text=await res.text();
    const rows=text.split("\n").slice(1);
    const data=rows.map(l=>{
      const p=parseCSVLine(l);
      return (p[0]&&p[1])?{q:p[0],a:p[1]}:null;
    }).filter(Boolean);
    masterData[k]=data;
    masterData.all=masterData.all.concat(data);
  }
  renderList();
}

/* ===== 修正② 検索 lowerCase ===== */
function renderList(){
  const s=document.getElementById('search')?.value.toLowerCase()||"";
  let list=masterData[activeGenre]||[];
  if(s){
    list=list.filter(i=>
      i.q.toLowerCase().includes(s)||
      i.a.toLowerCase().includes(s)
    );
  }else{
    list=[...list].sort(()=>Math.random()-.5).slice(0,30);
  }
  document.getElementById('quiz-list-area').innerHTML=
    list.map(i=>`<div onclick="applyQuiz('${i.q.replace(/'/g,"\\'")}','${i.a.replace(/'/g,"\\'")}')"
    style="${usedSet.has(i.q)?'opacity:.3':''};padding:10px;border-bottom:1px solid #eee;cursor:pointer">
    <b>${i.a}</b><br><small>${i.q}</small></div>`).join('');
}

/* ===== 修正③ winner transaction ===== */
function pushBtn(){
  const name=document.getElementById('p-name').value.trim();
  if(!name) return alert("名前を入力！");
  db.ref('winner').transaction(c=>c||name,(e,ok)=>{
    if(ok) db.ref('status').set('pushed');
  });
}

/* ===== 修正④ resumeQuiz 二重interval防止 ===== */
function resumeQuiz(){
  clearInterval(timer);
  db.ref('status').set('active');
  if(revealed.length<currentQuiz.q.length) startQuiz();
}

/* ===== 修正⑤ resetAll 完全化 ===== */
function resetAll(){
  if(confirm("全リセットしますか？")){
    history=[];
    usedSet.clear();
    db.ref().set({
      status:"idle",
      mode:"push",
      rankVisible:true,
      isGameSet:false,
      scores:null,
      waits:null,
      winner:null,
      boardAnswers:null,
      typing:null,
      correctList:null,
      wrongList:null
    });
  }
}
</script>

</body>
</html>
