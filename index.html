<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>QuizConsole Pro - The Perfect Final Master</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #f0f2f5; --primary: #3498db; --danger: #e74c3c; --success: #2ecc71; --dark: #2c3e50; --test: #6c5ce7; --gold: #f1c40f; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; height: 100vh; overflow: hidden; box-sizing: border-box; }
        .page-section { display: none; height: 100%; } 
        #role-ui { display: block; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .admin-flex { display: flex; gap: 15px; height: calc(100vh - 40px); max-width: 1600px; margin: 0 auto; }
        .main-panel { flex: 1; overflow-y: auto; padding-right: 5px; }
        .sidebar { width: 380px; display: flex; flex-direction: column; gap: 15px; height: 100%; }
        .sidebar-section { background: white; padding: 15px; border-radius: 12px; display: flex; flex-direction: column; min-height: 0; border: 1px solid #ddd; }
        #player-mgr-area { height: 35%; flex-shrink: 0; }
        #full-mgr-list { flex: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 5px; background: #fafafa; }
        #quiz-search-area { flex: 1; }
        #quiz-list-area { flex: 1; overflow-y: auto; margin-top: 10px; border: 1px solid #eee; border-radius: 8px; }
        #display { font-size: 1.8rem; background: var(--dark); color: white; padding: 20px; border-radius: 8px; min-height: 4em; display: flex; flex-wrap: wrap; margin-bottom: 15px; border: 4px solid #444; }
        #display span { border-bottom: 2px solid #555; margin-right: 2px; min-width: 0.8em; text-align: center; }
        #display span.hidden { visibility: hidden; }
        .btn-genre { padding: 6px; font-size: 0.7rem; cursor: pointer; flex: 1; border: 1px solid #ccc; background: #fff; border-radius: 4px; }
        .btn-genre.active { background: var(--primary); color: white; }
        .board-ans-item { background: #f8f9fa; border: 1px solid #ddd; padding: 8px; margin-top: 4px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #ccc; }
        .mgr-item { display: flex; align-items: center; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .type-btns button { padding: 8px 10px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background: white; font-weight: bold; font-size: 0.8rem; }
        #remote-button { width: 180px; height: 180px; border-radius: 50%; font-size: 2rem; font-weight: bold; cursor: pointer; border: 8px solid #eee; }
        #remote-button:not(:disabled) { background: var(--danger); color: white; border-color: #c0392b; }
    </style>
</head>
<body>

<script>
const firebaseConfig = {
  apiKey: "DUMMY_KEY_FOR_GITHUB_PAGES",
  authDomain: "realtime-database-c0015.firebaseapp.com",
  databaseURL: "https://realtime-database-c0015-default-rtdb.firebaseio.com",
  projectId: "realtime-database-c0015",
  storageBucket: "realtime-database-c0015.appspot.com",
  messagingSenderId: "000000000000",
  appId: "1:000000000000:web:dummy"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>


<script>
const firebaseConfig = { databaseURL: "https://realtime-database-c0015-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let masterData = { all: [] }, activeGenre = 'all', usedSet = new Set(),
    currentQuiz = { q: "", a: "" }, revealed = [], history = [];
let timer = null, subWindow = null, lastStatus = "";

/* ===== 修正① openType（waiting破壊防止）===== */
function openType(t) {
    db.ref().once('value', snap => {
        if (snap.val()?.status !== 'waiting') {
            db.ref('status').set('active');
        }
    });
    const m = {
        kanji:/[\u4E00-\u9FFF]/,
        hira:/[\u3040-\u309F]/,
        kana:/[\u30A0-\u30FF]/,
        num:/[0-9０-９]/,
        alp:/[a-zA-Zａ-ｚＡ-Ｚ]/,
        sym:/[！？、。：；／＿－＝＋＊＆％＄＃＠！”＃＄％＆’（）＊＋，－．／：；＜＝＞？＠［＼］＾＿｀｛｜｝～「」『』【】（）ⅠⅡⅢⅣⅤⅥⅦⅧⅨⅩ]/
    };
    let count = 0;
    Array.from(currentQuiz.q).forEach((c, i) => {
        if (m[t]?.test(c) && !revealed.includes(i)) {
            revealed.push(i); count++;
        }
    });
    if (count > 0) requestSound('type');
    sync();
}

/* ===== 修正②③ resumeQuiz ===== */
function resumeQuiz() {
    clearInterval(timer);
    db.ref('winner').set("");
    db.ref('status').set('active');
    if (revealed.length < currentQuiz.q.length) startQuiz();
}

/* ===== 修正④ applyQuiz（typing初期化）===== */
function applyQuiz(q, a) {
    clearInterval(timer);
    currentQuiz = { q, a };
    revealed = [];
    usedSet.add(q);
    history.push({ q, a });

    document.getElementById('admin-q-full').innerText = q;
    document.getElementById('admin-a-full').innerText = a;

    db.ref().update({
        status: "waiting",
        winner: "",
        correctList: null,
        wrongList: null,
        boardAnswers: null,
        typing: {},
        finalReveal: false,
        isGameSet: false
    });

    if (subWindow) subWindow.resetForNext();
    sync(true);
    renderList();
}

/* ===== 修正⑤ pushBtn ===== */
function pushBtn() {
    const name = document.getElementById('p-name').value.trim();
    if (!name) return alert("名前を入力！");
    db.ref('winner').transaction(c => {
        if (c) return c;
        return name;
    }, (err, ok) => {
        if (ok) db.ref('status').set('pushed');
    });
}

/* ===== 修正⑥ startQuiz ===== */
function startQuiz() {
    if (!currentQuiz.q) return;
    db.ref('status').set('active');
    const speed = parseInt(document.getElementById('readSpeed').value);
    clearInterval(timer);
    timer = setInterval(() => {
        if (revealed.length < currentQuiz.q.length) {
            let n = 0;
            while (revealed.includes(n)) n++;
            revealed.push(n);
            sync();
        } else clearInterval(timer);
    }, speed);
}

/* ===== 既存関数（変更なし）===== */
function sync(forceHideSub=false){
    const h = Array.from(currentQuiz.q).map((c,i)=>
        revealed.includes(i)?`<span>${c}</span>`:`<span class="hidden">${c}</span>`
    ).join('');
    document.getElementById('display').innerHTML = h;
    if (subWindow && !forceHideSub) subWindow.document.getElementById('text').innerHTML = h;
}
</script>

</body>
</html>

